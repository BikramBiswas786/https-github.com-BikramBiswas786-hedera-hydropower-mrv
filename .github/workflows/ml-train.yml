name: ML Model Training Pipeline

on:
  workflow_dispatch:  # Manual trigger only
  schedule:
    - cron: '0 2 * * 0'  # Every Sunday at 2 AM UTC

jobs:
  generate-data:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        persist-credentials: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm ci

    - name: Generate training data
      run: npm run ml:generate-data

    - name: Upload training data
      uses: actions/upload-artifact@v4
      with:
        name: training-data
        path: ml/data/
        retention-days: 30

  train-model:
    runs-on: ubuntu-latest
    needs: generate-data

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm ci

    - name: Download training data
      uses: actions/download-artifact@v4
      with:
        name: training-data
        path: ml/data/

    - name: Train ML model
      run: npm run ml:train

    - name: Upload trained model
      uses: actions/upload-artifact@v4
      with:
        name: ml-model
        path: ml/model.json
        retention-days: 90

    - name: Commit model (optional)
      if: github.event_name == 'workflow_dispatch'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add ml/model.json
        git diff --staged --quiet || git commit -m "bot: Update ML model [skip ci]"
        git push

  test-integration:
    runs-on: ubuntu-latest
    needs: train-model

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm ci

    - name: Download trained model
      uses: actions/download-artifact@v4
      with:
        name: ml-model
        path: ml/

    - name: Run ML integration tests
      run: npm test -- tests/ml/ --forceExit
      env:
        NODE_ENV: test

    - name: Test Summary
      if: always()
      run: |
        echo "## ML Training Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Status:** ML model trained and tested successfully" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š **Node Version:** 18.x" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ¤– **Model:** ml/model.json" >> $GITHUB_STEP_SUMMARY
