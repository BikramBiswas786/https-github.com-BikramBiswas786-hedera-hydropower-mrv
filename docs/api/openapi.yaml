openapi: 3.0.3
info:
  title: Hedera Hydropower MRV API
  version: 1.0.0
  description: |
    **Production-grade MRV** (Measurement, Reporting, Verification) system for hydropower plants.
    
    ## Features
    - **AI Guardian Verification**: Multi-layer anomaly detection with 5-factor trust scoring
    - **Hedera Blockchain**: Immutable audit trail on Hedera Consensus Service (HCS)
    - **Carbon Tokenization**: Automated HREC token minting on Hedera Token Service (HTS)
    - **Real-time Fraud Detection**: ML-powered anomaly detection with rule-based fallback
    
    ## Authentication
    All endpoints require an API key passed via the `X-API-Key` header.
    
    Get your API key:
    1. Register your organization: `POST /organizations/register`
    2. Use the returned `api_key` in all subsequent requests
    
    ## Rate Limits
    - **Free Tier**: 1,000 requests/hour
    - **Pilot Tier**: 10,000 requests/hour
    - **Enterprise**: Custom limits
    
    ## Support
    - **Documentation**: https://github.com/BikramBiswas786/hedera-hydropower-mrv
    - **Issues**: https://github.com/BikramBiswas786/hedera-hydropower-mrv/issues
    - **Email**: bikrambiswas007@gmail.com
  
  contact:
    name: MRV API Support
    email: bikrambiswas007@gmail.com
    url: https://github.com/BikramBiswas786/hedera-hydropower-mrv
  
  license:
    name: MIT
    url: https://github.com/BikramBiswas786/hedera-hydropower-mrv/blob/main/LICENSE

servers:
  - url: https://hydropower-mrv-19feb26.vercel.app/api
    description: Production (Vercel)
  - url: http://localhost:3000/api/v1
    description: Local development

security:
  - ApiKeyAuth: []

tags:
  - name: Telemetry
    description: Submit and query telemetry readings
  - name: Attestations
    description: Verification attestations and audit trail
  - name: Organizations
    description: Organization and device management
  - name: System
    description: System health and status

paths:
  /telemetry:
    post:
      summary: Submit telemetry reading
      description: |
        Submit a single telemetry reading for MRV verification.
        
        **Verification Pipeline:**
        1. Device signature validation
        2. Physics-based power calculation check
        3. Temporal consistency validation (vs. previous readings)
        4. Environmental bounds verification (pH, turbidity, temperature)
        5. ML anomaly detection (if model available)
        6. Trust score computation (weighted average of 5 checks)
        7. Auto-decision: APPROVED (>0.90) / FLAGGED (0.50-0.90) / REJECTED (<0.50)
        8. Hedera HCS anchoring (if APPROVED)
        9. Carbon credit calculation (ACM0002 methodology)
        
        **Response Time:** Typically 200-500ms (P95)
      
      operationId: submitTelemetry
      tags:
        - Telemetry
      
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TelemetryReading'
            examples:
              normal_operation:
                summary: Normal operating conditions
                value:
                  device_id: "turbine-01"
                  plant_id: "alaknanda-hpp"
                  timestamp: "2026-02-20T18:00:00Z"
                  flow_rate: 12.5
                  head: 45.2
                  efficiency: 0.87
                  generated_kwh: 4.8
                  water_quality:
                    ph: 7.2
                    turbidity: 8.5
                    temperature: 15.0
              
              high_flow:
                summary: Monsoon high-flow conditions
                value:
                  device_id: "turbine-02"
                  plant_id: "alaknanda-hpp"
                  timestamp: "2026-07-15T14:30:00Z"
                  flow_rate: 25.8
                  head: 45.0
                  efficiency: 0.89
                  generated_kwh: 10.2
                  water_quality:
                    ph: 7.0
                    turbidity: 15.0
                    temperature: 18.5
              
              suspicious_reading:
                summary: Potentially fraudulent (efficiency too high)
                value:
                  device_id: "turbine-03"
                  plant_id: "rogue-plant"
                  timestamp: "2026-02-20T18:00:00Z"
                  flow_rate: 5.0
                  head: 20.0
                  efficiency: 0.99
                  generated_kwh: 15.0
                  water_quality:
                    ph: 6.5
                    turbidity: 5.0
                    temperature: 14.0
      
      responses:
        '200':
          description: Verification completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationResult'
              examples:
                approved:
                  summary: Reading approved and anchored
                  value:
                    verification_id: "550e8400-e29b-41d4-a716-446655440000"
                    status: "APPROVED"
                    method: "AI_AUTO_APPROVED"
                    trust_score: 0.956
                    hedera_tx_id: "0.0.5190825@1708451234.567890123"
                    hashscan_url: "https://hashscan.io/testnet/transaction/0.0.5190825@1708451234.567890123"
                    timestamp: "2026-02-20T18:00:15Z"
                    carbon_credits:
                      generated_kwh: 4.8
                      emission_reduction_tco2: 0.0039
                      hrec_token_eligible: true
                    checks:
                      physics: { score: 0.98, status: "pass" }
                      temporal: { score: 0.95, status: "pass" }
                      environmental: { score: 1.0, status: "pass" }
                      statistical: { score: 0.92, status: "pass" }
                      ml_anomaly: { score: 0.88, status: "pass", method: "ISOLATION_FOREST" }
                
                flagged:
                  summary: Reading flagged for manual review
                  value:
                    verification_id: "660e8400-e29b-41d4-a716-446655440001"
                    status: "FLAGGED"
                    method: "MANUAL_REVIEW_REQUIRED"
                    trust_score: 0.752
                    hedera_tx_id: null
                    timestamp: "2026-02-20T18:05:20Z"
                    reason: "Temporal consistency score below threshold"
                    checks:
                      physics: { score: 0.95, status: "pass" }
                      temporal: { score: 0.68, status: "warning" }
                      environmental: { score: 0.90, status: "pass" }
                      statistical: { score: 0.70, status: "warning" }
                      ml_anomaly: { score: 0.75, status: "pass" }
                
                rejected:
                  summary: Reading rejected (fraudulent)
                  value:
                    verification_id: "770e8400-e29b-41d4-a716-446655440002"
                    status: "REJECTED"
                    method: "AUTO_REJECTED"
                    trust_score: 0.312
                    hedera_tx_id: null
                    timestamp: "2026-02-20T18:10:45Z"
                    reason: "Physics validation failed: expected 1.0 kW, measured 15.0 kW (1400% deviation)"
                    checks:
                      physics: { score: 0.05, status: "fail" }
                      temporal: { score: 0.60, status: "warning" }
                      environmental: { score: 0.85, status: "pass" }
                      statistical: { score: 0.40, status: "fail" }
                      ml_anomaly: { score: 0.15, status: "fail", method: "ISOLATION_FOREST" }
        
        '400':
          description: Invalid request (missing required fields or validation error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Validation failed"
                details:
                  - field: "flow_rate"
                    message: "Must be a positive number"
                  - field: "timestamp"
                    message: "Cannot be in the future"
        
        '401':
          description: Missing or invalid API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Missing x-api-key header"
                docs: "https://github.com/BikramBiswas786/.../API.md#authentication"
        
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Rate limit exceeded"
                limit: 1000
                window: "1 hour"
                retry_after: 3456
        
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Hedera transaction failed after 3 retries"
                correlation_id: "req_abc123xyz"

  /telemetry/batch:
    post:
      summary: Submit batch of telemetry readings
      description: |
        Submit multiple telemetry readings in a single request for higher throughput.
        
        **Batch Limits:**
        - Max 100 readings per request
        - All readings must be from the same organization
        - Partial success supported (some may pass, others fail)
      
      operationId: submitTelemetryBatch
      tags:
        - Telemetry
      
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [readings]
              properties:
                readings:
                  type: array
                  minItems: 1
                  maxItems: 100
                  items:
                    $ref: '#/components/schemas/TelemetryReading'
      
      responses:
        '200':
          description: Batch processed (partial success possible)
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                    example: 50
                  successful:
                    type: integer
                    example: 48
                  failed:
                    type: integer
                    example: 2
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/VerificationResult'

  /attestations:
    get:
      summary: Query verification attestations
      description: |
        Retrieve verification attestations for your organization.
        
        **Filters:**
        - Time range (start_date, end_date)
        - Device ID
        - Verification status (APPROVED, FLAGGED, REJECTED)
        - Trust score range
        
        **Pagination:** Cursor-based for large result sets
      
      operationId: listAttestations
      tags:
        - Attestations
      
      parameters:
        - name: device_id
          in: query
          description: Filter by device ID
          schema:
            type: string
          example: "turbine-01"
        
        - name: status
          in: query
          description: Filter by verification status
          schema:
            type: string
            enum: [APPROVED, FLAGGED, REJECTED]
        
        - name: start_date
          in: query
          description: Start of time range (ISO 8601)
          schema:
            type: string
            format: date-time
          example: "2026-02-01T00:00:00Z"
        
        - name: end_date
          in: query
          description: End of time range (ISO 8601)
          schema:
            type: string
            format: date-time
          example: "2026-02-28T23:59:59Z"
        
        - name: min_trust_score
          in: query
          description: Minimum trust score filter
          schema:
            type: number
            minimum: 0
            maximum: 1
          example: 0.90
        
        - name: limit
          in: query
          description: Number of results per page
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        
        - name: cursor
          in: query
          description: Pagination cursor from previous response
          schema:
            type: string
      
      responses:
        '200':
          description: Attestations retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Attestation'
                  pagination:
                    type: object
                    properties:
                      total:
                        type: integer
                        example: 1523
                      has_more:
                        type: boolean
                        example: true
                      next_cursor:
                        type: string
                        example: "eyJpZCI6IjU1MGU4NDAwLWUyOWIifQ=="

  /attestations/{verification_id}:
    get:
      summary: Get single attestation by ID
      description: Retrieve detailed verification attestation including all check scores and Hedera transaction details.
      operationId: getAttestation
      tags:
        - Attestations
      
      parameters:
        - name: verification_id
          in: path
          required: true
          description: Unique verification ID
          schema:
            type: string
            format: uuid
      
      responses:
        '200':
          description: Attestation found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Attestation'
        
        '404':
          description: Attestation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /organizations/register:
    post:
      summary: Register new organization
      description: |
        Self-service organization registration.
        
        **What happens:**
        1. Organization record created in database
        2. API key generated and returned (store securely!)
        3. Hedera account created (optional, for dedicated accounts)
        4. Welcome email sent with onboarding guide
        
        **No credit card required for pilot tier.**
      
      operationId: registerOrganization
      tags:
        - Organizations
      security: []
      
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, contact_email, plant_name]
              properties:
                name:
                  type: string
                  description: Legal organization name
                  example: "Green Energy Pvt Ltd"
                contact_email:
                  type: string
                  format: email
                  example: "admin@greenergy.com"
                plant_name:
                  type: string
                  example: "Alaknanda Hydropower Plant"
                capacity_mw:
                  type: number
                  minimum: 0.1
                  example: 5.6
                location:
                  type: object
                  properties:
                    lat:
                      type: number
                      minimum: -90
                      maximum: 90
                      example: 30.2833
                    lon:
                      type: number
                      minimum: -180
                      maximum: 180
                      example: 79.3167
                    country:
                      type: string
                      example: "India"
      
      responses:
        '201':
          description: Organization registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  org_id:
                    type: string
                    format: uuid
                    example: "550e8400-e29b-41d4-a716-446655440000"
                  api_key:
                    type: string
                    description: Store securely - shown only once!
                    example: "mrv_prod_Ak8s9dkF3jKs8dkS9fkD3s"
                  hedera_account_id:
                    type: string
                    example: "0.0.5190825"
                  onboarding_status:
                    type: string
                    example: "pending_verification"
                  next_steps:
                    type: array
                    items:
                      type: string
                    example:
                      - "Download edge agent: curl https://mrv.app/install.sh | bash"
                      - "Configure sensors: mrv-agent configure --api-key=..."
                      - "Test telemetry: mrv-agent test-submit"

  /status:
    get:
      summary: System health check
      description: |
        Public health check endpoint (no authentication required).
        
        Returns:
        - API version and uptime
        - Hedera network status
        - Test suite statistics
        - Recent performance metrics
      
      operationId: getStatus
      tags:
        - System
      security: []
      
      responses:
        '200':
          description: System operational
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "operational"
                  version:
                    type: string
                    example: "1.0.0"
                  uptime_seconds:
                    type: integer
                    example: 1234567
                  hedera:
                    type: object
                    properties:
                      network:
                        type: string
                        example: "testnet"
                      operator_account:
                        type: string
                        example: "0.0.5190825"
                      hcs_topic:
                        type: string
                        example: "0.0.5190826"
                      hts_token:
                        type: string
                        example: "0.0.5190827"
                      transaction_success_rate:
                        type: number
                        example: 0.992
                  tests:
                    type: object
                    properties:
                      total:
                        type: integer
                        example: 224
                      passing:
                        type: integer
                        example: 224
                      coverage:
                        type: number
                        example: 85.3
                  performance:
                    type: object
                    properties:
                      p50_latency_ms:
                        type: integer
                        example: 180
                      p95_latency_ms:
                        type: integer
                        example: 450
                      p99_latency_ms:
                        type: integer
                        example: 890

  /demo:
    get:
      summary: Run demo verification pipeline
      description: |
        Execute end-to-end demo showing:
        1. Normal reading (should pass)
        2. Suspicious reading (should be flagged/rejected)
        3. Hedera anchoring
        4. Carbon credit calculation
        
        Useful for testing and demonstrations.
      
      operationId: runDemo
      tags:
        - System
      security: []
      
      responses:
        '200':
          description: Demo completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  demo_timestamp:
                    type: string
                    format: date-time
                  scenarios:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        result:
                          $ref: '#/components/schemas/VerificationResult'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        API key obtained from organization registration.
        
        Format: `mrv_prod_<random_string>` (production) or `mrv_test_<random_string>` (sandbox)
        
        **Get your API key:**
        1. `POST /organizations/register` with your organization details
        2. Store the returned `api_key` securely (shown only once)
        3. Pass it in the `X-API-Key` header for all requests
        
        **Security:**
        - Never commit API keys to version control
        - Rotate keys every 90 days
        - Use separate keys for dev/staging/production
  
  schemas:
    TelemetryReading:
      type: object
      required:
        - device_id
        - timestamp
        - flow_rate
        - head
        - generated_kwh
      properties:
        device_id:
          type: string
          description: Unique device identifier
          example: "turbine-01"
        plant_id:
          type: string
          description: Plant identifier (optional if device is already registered)
          example: "alaknanda-hpp"
        timestamp:
          type: string
          format: date-time
          description: Reading timestamp (ISO 8601, UTC)
          example: "2026-02-20T18:00:00Z"
        flow_rate:
          type: number
          description: Water flow rate in m³/s
          minimum: 0
          example: 12.5
        head:
          type: number
          description: Hydraulic head in meters
          minimum: 0
          example: 45.2
        efficiency:
          type: number
          description: Turbine efficiency (0-1)
          minimum: 0
          maximum: 1
          example: 0.87
        generated_kwh:
          type: number
          description: Power output in kWh for the measurement period
          minimum: 0
          example: 4.8
        water_quality:
          type: object
          description: Optional water quality metrics
          properties:
            ph:
              type: number
              minimum: 0
              maximum: 14
              example: 7.2
            turbidity:
              type: number
              description: NTU (Nephelometric Turbidity Units)
              minimum: 0
              example: 8.5
            temperature:
              type: number
              description: Temperature in Celsius
              example: 15.0
        signature:
          type: string
          description: Device signature (Ed25519) for authenticity
          example: "base64_encoded_signature"
    
    VerificationResult:
      type: object
      properties:
        verification_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        status:
          type: string
          enum: [APPROVED, FLAGGED, REJECTED]
          description: |
            - APPROVED: Trust score ≥0.90, anchored to Hedera
            - FLAGGED: Trust score 0.50-0.89, needs manual review
            - REJECTED: Trust score <0.50, not anchored
          example: "APPROVED"
        method:
          type: string
          enum: [AI_AUTO_APPROVED, MANUAL_REVIEW_REQUIRED, AUTO_REJECTED]
          example: "AI_AUTO_APPROVED"
        trust_score:
          type: number
          minimum: 0
          maximum: 1
          description: Weighted composite score from 5 verification checks
          example: 0.956
        hedera_tx_id:
          type: string
          nullable: true
          description: Hedera transaction ID (null if not anchored)
          example: "0.0.5190825@1708451234.567890123"
        hashscan_url:
          type: string
          format: uri
          nullable: true
          example: "https://hashscan.io/testnet/transaction/0.0.5190825@1708451234.567890123"
        timestamp:
          type: string
          format: date-time
          example: "2026-02-20T18:00:15Z"
        reason:
          type: string
          nullable: true
          description: Explanation for FLAGGED/REJECTED status
          example: "Physics validation failed: 1400% deviation from expected power"
        carbon_credits:
          type: object
          nullable: true
          properties:
            generated_kwh:
              type: number
              example: 4.8
            emission_reduction_tco2:
              type: number
              description: Tons of CO2 equivalent avoided
              example: 0.0039
            methodology:
              type: string
              example: "ACM0002 v18.0"
            grid_emission_factor:
              type: number
              description: tCO2/MWh
              example: 0.82
            hrec_token_eligible:
              type: boolean
              example: true
        checks:
          type: object
          description: Detailed scores for each verification layer
          properties:
            physics:
              $ref: '#/components/schemas/CheckResult'
            temporal:
              $ref: '#/components/schemas/CheckResult'
            environmental:
              $ref: '#/components/schemas/CheckResult'
            statistical:
              $ref: '#/components/schemas/CheckResult'
            ml_anomaly:
              $ref: '#/components/schemas/CheckResult'
    
    CheckResult:
      type: object
      properties:
        score:
          type: number
          minimum: 0
          maximum: 1
          example: 0.98
        status:
          type: string
          enum: [pass, warning, fail]
          example: "pass"
        method:
          type: string
          nullable: true
          example: "ISOLATION_FOREST"
        details:
          type: object
          nullable: true
          additionalProperties: true
    
    Attestation:
      type: object
      properties:
        verification_id:
          type: string
          format: uuid
        device_id:
          type: string
        timestamp:
          type: string
          format: date-time
        status:
          type: string
          enum: [APPROVED, FLAGGED, REJECTED]
        trust_score:
          type: number
        hedera_tx_id:
          type: string
          nullable: true
        hashscan_url:
          type: string
          format: uri
          nullable: true
        created_at:
          type: string
          format: date-time
        reading_data:
          $ref: '#/components/schemas/TelemetryReading'
        verification_data:
          $ref: '#/components/schemas/VerificationResult'
    
    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Human-readable error message
          example: "Invalid API key"
        details:
          type: object
          nullable: true
          description: Additional error context
          additionalProperties: true
        correlation_id:
          type: string
          nullable: true
          description: Request correlation ID for support
          example: "req_abc123xyz"
        docs:
          type: string
          format: uri
          nullable: true
          description: Link to relevant documentation
          example: "https://github.com/BikramBiswas786/.../API.md#authentication"
